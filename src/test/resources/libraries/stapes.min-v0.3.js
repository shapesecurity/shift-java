//
//  ____  _                           _
// / ___|| |_ __ _ _ __   ___  ___   (_)___  (*)
// \___ \| __/ _` | '_ \ / _ \/ __|  | / __|
//  ___) | || (_| | |_) |  __/\__ \_ | \__ \
// |____/ \__\__,_| .__/ \___||___(_)/ |___/
//              |_|              |__/
//
// (*) a (really) tiny Javascript MVC microframework
//
// (c) Hay Kranen < hay@bykr.org >
// Released under the terms of the MIT license
// < http://en.wikipedia.org/wiki/MIT_License >
//
// Stapes.js : http://hay.github.com/stapes
(function(){function g(a,c){var d=this.get(a),e=c(b.clone(d));f.call(this,a,e)}function f(a,b){var c=this.has(a),d=j._attributes[this._guid][a];if(b!==d){j._attributes[this._guid][a]=b,this.emit("change",a),this.emit("change:"+a,b);var e={key:a,newValue:b,oldValue:d||null};this.emit("mutate",e),this.emit("mutate:"+a,e);var f=c?"update":"create";this.emit(f,a),this.emit(f+":"+a,b)}}function e(a,c,d,e){d=d||!1,e=e||this._guid,b.each(j._eventHandlers[e][a],b.bind(function(a){var b=a.scope?a.scope:this;d&&(a.type=d),a.scope=b,a.handler.call(a.scope,c,a)},this))}function d(a,d,e){var f={},g;typeof a=="string"?(g=e||!1,f[a]=d):(g=d||!1,f=a),b.each(f,b.bind(function(a,d){var e=d.split(" ");b.each(e,b.bind(function(b){c.call(this,{guid:this._guid,handler:a,scope:g,type:b})},this))},this))}function c(a){j._eventHandlers[a.guid][a.type]||(j._eventHandlers[a.guid][a.type]=[]),j._eventHandlers[a.guid][a.type].push({guid:a.guid,handler:a.handler,scope:a.scope,type:a.type})}var a="0.3",b={bind:function(a,b){return Function.prototype.bind?a.bind(b):function(){return a.apply(b,arguments)}},clone:function(a){if(b.isArray(a))return a.slice();if(b.isObject(a)){var c={};b.each(a,function(a,b){c[b]=a});return c}return a},create:function(a){var b;if(typeof Object.create=="function")b=Object.create(a);else{var c=function(){};c.prototype=a,b=new c}b._guid=h++,j._attributes[b._guid]={},j._eventHandlers[b._guid]={};return b},each:function(a,c){if(b.isArray(a))if(Array.prototype.forEach)a.forEach(c);else for(var d=0,e=a.length;d<e;d++)c(a[d],d);else for(var f in a)c(a[f],f)},isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return typeof a=="object"&&!b.isArray(a)&&a!==null},makeUuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0,c=a=="x"?b:b&3|8;return c.toString(16)})},toArray:function(a){return b.isObject(a)?b.values(a):Array.prototype.slice.call(a,0)},values:function(a){var c=[];b.each(a,function(a,b){c.push(a)});return c}},h=1,i={create:function(){return b.create(this)},emit:function(a,c){c=c||null,b.each(a.split(" "),b.bind(function(a){j._eventHandlers[-1].all&&e.call(this,"all",c,a,-1),j._eventHandlers[-1][a]&&e.call(this,a,c,a,-1),typeof this._guid=="number"&&(j._eventHandlers[this._guid].all&&e.call(this,"all",c,a),j._eventHandlers[this._guid][a]&&e.call(this,a,c))},this))},extend:function(a,c){var d=c?a:this,e=c?c:a;b.each(e,function(a,b){d[b]=a});return this},filter:function(a){var c=[];b.each(j._attributes[this._guid],function(b){a(b)&&c.push(b)});return c},get:function(a){if(typeof a=="string")return this.has(a)?j._attributes[this._guid][a]:null;if(typeof a=="function"){var b=this.filter(a);return b.length?b[0]:!1}},getAll:function(){return b.clone(j._attributes[this._guid])},getAllAsArray:function(){var a=[];b.each(j._attributes[this._guid],function(c,d){b.isObject(c)&&(c.id=d),a.push(c)});return b.clone(a)},has:function(a){return typeof j._attributes[this._guid][a]!="undefined"},init:function(){this.emit("ready");return this},on:function(){d.apply(this,arguments)},push:function(a){b.isArray(a)?b.each(a,b.bind(function(a){f.call(this,b.makeUuid(),a)},this)):f.call(this,b.makeUuid(),a)},remove:function(a){typeof a=="function"?b.each(j._attributes[this._guid],b.bind(function(b,c){a(b)&&(delete j._attributes[this._guid][c],this.emit("remove change"))},this)):(typeof a=="string"&&(a=[a]),b.each(b.toArray(a),b.bind(function(a){this.has(a)&&(delete j._attributes[this._guid][a],this.emit("remove change"))},this)))},set:function(a,c){b.isObject(a)?b.each(a,b.bind(function(a,b){f.call(this,b,a)},this)):f.call(this,a,c)},update:function(a,c){typeof a=="string"?g.call(this,a,c):typeof a=="function"&&b.each(this.getAll(),b.bind(function(b,c){g.call(this,c,a)},this))}},j={_attributes:{},_eventHandlers:{"-1":{}},_guid:-1,create:function(){return b.create(i)},extend:function(a){b.each(a,function(a,b){i[b]=a})},on:function(){d.apply(this,arguments)},version:a};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=j),exports.Stapes=j):typeof define=="function"&&define.amd?define(function(){return j}):window.Stapes=j})()